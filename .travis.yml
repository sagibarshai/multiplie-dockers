sudo: required # because docker in use
services:
  - docker

before_install:
  # download google cloud sdk
  - openssl aes-256-cbc -K $encrypted_9f3b5599b056_key -iv $encrypted_9f3b5599b056_iv -in service-account.json.enc -out service-account.json -d
  - curl https://sdk.cloud.google.com | bash > /dev/null;
  - source $HOME/google-cloud-sdk/path.bash.inc
  - gcloud component update kubectl
  - gcloud auth activate-service-account --key-file service-account.json
  - docker build -f ./client/Dockerfile.dev -t 315426346/client:latest ./client
  - docker run -e CI=true 315426346/client npm run test

script:
  # 1) build add images
  # 2) login to docker
  # 3) push to docker hub
  - docker build -t 315426346/client:latest ./client
  - docker build -t 315426346/worker:latest ./worker
  - docker build -t 315426346/server:latest ./server

  - echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_ID --password-stdin

  - docker push 315426346/client:latest 
  - docker push 315426346/worker:latest
  - docker push 315426346/server:latest
